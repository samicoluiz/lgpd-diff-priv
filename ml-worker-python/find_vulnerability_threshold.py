import pandas as pd
import numpy as np
from anonymeter.evaluators import SinglingOutEvaluator
import warnings

# Silenciando warnings de confian√ßa para limpar a sa√≠da do terminal
warnings.filterwarnings("ignore", category=UserWarning)

def run_test_agressivo(df, cols, label):
    # Seleciona um subconjunto min√∫sculo para aumentar a densidade do ataque
    # 200 alvos contra apenas 800 pessoas de popula√ß√£o.
    df_mini = df[cols].dropna().astype(str).sample(n=1000, random_state=42)
    
    df_targets = df_mini.iloc[:200]
    df_pop = df_mini.iloc[200:]
    
    evaluator = SinglingOutEvaluator(ori=df_targets, syn=df_pop)
    evaluator.evaluate()
    
    risk = evaluator.risk().value
    print(f">> {label} | Privacy Score: {1.0 - risk:.4f} | Risco: {risk:.4f}")

# CAMINHO REAL DO SEU ARQUIVO
DATA_PATH = "/mnt/c/Users/looui/Documents/projetos/tcc/lgpd-diff-priv/backend-go/data/raw_consulta_cand_2024_BRASIL.csv"

try:
    print("--- üéØ BUSCA PELO LIMIAR DE VULNERABILIDADE ---")
    df = pd.read_csv(DATA_PATH, sep=';', encoding='iso-8859-1', low_memory=False)
    print(f"[INFO] Dataset carregado com {len(df)} linhas.")

    # CEN√ÅRIO 1: Quase-identificadores completos (Alta Dimensionalidade)
    # Esperamos Score ALTO (falsa seguran√ßa por esparsidade)
    cols1 = ['SG_UF', 'NM_UE', 'NR_PARTIDO', 'CD_GENERO', 'CD_GRAU_INSTRUCAO', 'CD_COR_RACA', 'CD_OCUPACAO', 'DT_NASCIMENTO']
    
    # CEN√ÅRIO 2: Identificadores Sociais (M√©dia Dimensionalidade)
    cols2 = ['NM_UE', 'NR_PARTIDO', 'CD_GENERO', 'DT_NASCIMENTO']
    
    # CEN√ÅRIO 3: Identificadores Cr√≠ticos (Baixa Dimensionalidade)
    # Aqui o Score deve CAIR, provando a vulnerabilidade real
    cols3 = ['NM_UE', 'CD_GENERO', 'DT_NASCIMENTO']

    run_test_agressivo(df, cols1, "Cen√°rio 1: Completo")
    run_test_agressivo(df, cols2, "Cen√°rio 2: Reduzido")
    run_test_agressivo(df, cols3, "Cen√°rio 3: M√≠nimo Cr√≠tico")

    print("\n-------------------------------------------")
    print("An√°lise conclu√≠da. O cen√°rio com MENOR Privacy Score")
    print("√© o seu 'alvo' para prote√ß√£o com o AIM.")

except FileNotFoundError:
    print(f"[ERRO] Arquivo n√£o encontrado em: {DATA_PATH}")
except Exception as e:
    print(f"[ERRO] Ocorreu um problema: {e}")