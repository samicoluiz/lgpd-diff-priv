import pandas as pd
import numpy as np
import time
import warnings
import json

# Importa√ß√µes confirmadas pelo seu ambiente
from anonymeter.evaluators import SinglingOutEvaluator, LinkabilityEvaluator, InferenceEvaluator

warnings.filterwarnings("ignore", category=UserWarning)

def get_risk_label(risk_value):
    """Classifica o risco baseado na escala de Giomi et al. (2022)"""
    if risk_value <= 0.05:
        return "‚úÖ INSIGNIFICANTE"
    elif risk_value <= 0.20:
        return "‚ö†Ô∏è MODERADO"
    elif risk_value <= 0.50:
        return "üö® ALTO"
    else:
        return "üî• CR√çTICO"

def run_system_audit(df_ori, df_obs, aux_cols):
    """Realiza a auditoria multi-alvo para infer√™ncia de atributos"""
    targets = ['CD_COR_RACA', 'CD_GRAU_INSTRUCAO', 'CD_ESTADO_CIVIL']
    results = {}

    print("\n--- üõ°Ô∏è  AUDITORIA DE SISTEMA (INFER√äNCIA MULTI-ALVO) ---")

    for target in targets:
        # Verifica se a coluna existe no dataframe amostrado
        if target not in df_ori.columns:
            continue
            
        eval_inf = InferenceEvaluator(ori=df_ori, syn=df_obs, aux_cols=aux_cols, secret=target)
        eval_inf.evaluate()
        
        risk = eval_inf.risk().value
        results[target] = {
            "risk": risk,
            "label": get_risk_label(risk)
        }
        print(f"Alvo: {target:20} | Risco: {risk:.4f} | Status: {results[target]['label']}")

    avg_risk = sum(item['risk'] for item in results.values()) / len(results)
    max_risk = max(item['risk'] for item in results.values())
    
    print("-" * 65)
    print(f"Risco M√©dio do Sistema: {avg_risk:.4f} ({get_risk_label(avg_risk)})")
    print(f"Risco Cr√≠tico (Worst-case): {max_risk:.4f}")
    
    return results, avg_risk

def main():
    PATH = "/mnt/c/Users/looui/Documents/projetos/tcc/lgpd-diff-priv/backend-go/data/raw_consulta_cand_2024_BRASIL.csv"
    
    print("--- üî¨ INICIANDO AUDITORIA DE VULNERABILIDADE (DADO BRUTO) ---")
    
    # 1. Carregamento √önico
    try:
        df = pd.read_csv(PATH, sep=';', encoding='iso-8859-1', low_memory=False)
        print(f"[INFO] Dataset carregado: {len(df)} linhas.")
    except Exception as e:
        print(f"[ERRO] Falha ao carregar arquivo: {e}")
        return

    # 2. Configura√ß√£o de Atributos
    aux_cols = ['NM_UE', 'SG_PARTIDO', 'DT_NASCIMENTO', 'CD_GENERO']
    targets = ['CD_COR_RACA', 'CD_GRAU_INSTRUCAO', 'CD_ESTADO_CIVIL']
    
    # 3. Prepara√ß√£o da Amostra (Aumentei para 15k para cobrir todos os targets com folga)
    cols_to_use = aux_cols + targets
    df_sample = df[cols_to_use].dropna().astype(str).sample(n=15000, random_state=42)
    
    # Split para simular ataque (Control vs Target)
    df_ori = df_sample.iloc[:7500]
    df_obs = df_sample.iloc[7500:]

    # 4. Execu√ß√£o dos Testes
    # Teste de Liga√ß√£o (Linkability) - Comparando Ori contra si mesma para ver unicidade real
    # Nota: Em um teste de Linkability em dados RAW, usamos uma pequena sobreposi√ß√£o 
    # para provar que a liga√ß√£o √© fatal.
    print(f"\n[ATAQUE] Linkability Attack (Amostra Controlada)... ", end="", flush=True)
    eval_link = LinkabilityEvaluator(ori=df_ori, syn=df_ori, aux_cols=aux_cols)
    eval_link.evaluate()
    link_risk = eval_link.risk().value
    print(f"Risco: {link_risk:.4f} ({get_risk_label(link_risk)})")

    # Auditoria de Sistema (Infer√™ncia)
    audit_results, avg_sys_risk = run_system_audit(df_ori, df_obs, aux_cols)

    # 5. Exporta√ß√£o para o Dashboard
    summary = {
        "timestamp": time.strftime("%Y-%m-%d %H:%M:%S"),
        "linkability_risk": link_risk,
        "inference_avg_risk": avg_sys_risk,
        "details": audit_results
    }
    
    with open("raw_audit_summary.json", "w") as f:
        json.dump(summary, f, indent=4)
    print(f"\n[DONE] Resultados salvos em 'raw_audit_summary.json'")

if __name__ == "__main__":
    main()